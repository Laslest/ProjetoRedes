<!doctype html>
<html lang="pt-BR">
<head>
	<meta charset="utf-8">
	<title>Projeto Redes Chat</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
		:root {
			color-scheme: light dark;
			font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
		}
		body {
			margin: 0;
			min-height: 100vh;
			display: grid;
			place-items: center;
			background: radial-gradient(circle at top, #4f46e5 0%, #1f2937 55%, #0f172a 100%);
			color: #f3f4f6;
		}
		.chat-container {
			width: min(960px, 95vw);
			height: min(640px, 90vh);
			background: rgba(15, 23, 42, 0.8);
			border-radius: 16px;
			display: grid;
			grid-template-rows: auto 1fr auto;
			padding: 24px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
			-webkit-backdrop-filter: blur(12px);
			backdrop-filter: blur(12px);
		}
		header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
		}
		h1 {
			margin: 0;
			font-size: 1.5rem;
		}
		.status {
			padding: 6px 14px;
			border-radius: 999px;
			font-size: 0.9rem;
			font-weight: 600;
			border: 1px solid rgba(255, 255, 255, 0.2);
		}
		.status-online {
			color: #bbf7d0;
			border-color: #22c55e;
		}
		.status-offline {
			color: #fecdd3;
			border-color: #f43f5e;
		}
		#chat-log {
			margin: 20px 0;
			padding: 16px;
			border-radius: 12px;
			background: rgba(15, 23, 42, 0.55);
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			gap: 10px;
		}
		.message {
			padding: 10px 14px;
			border-radius: 10px;
			background: rgba(59, 130, 246, 0.15);
			border: 1px solid rgba(59, 130, 246, 0.25);
			word-break: break-word;
		}
		.system {
			background: rgba(251, 191, 36, 0.15);
			border-color: rgba(251, 191, 36, 0.3);
			text-align: center;
			font-size: 0.9rem;
			font-style: italic;
		}
		form {
			display: flex;
			gap: 12px;
		}
		input[type="text"] {
			flex: 1;
			padding: 14px;
			border-radius: 10px;
			border: none;
			font-size: 1rem;
			background: rgba(255, 255, 255, 0.1);
			color: inherit;
		}
		input[type="text"]:focus {
			outline: 2px solid #3b82f6;
		}
		button {
			padding: 0 22px;
			border: none;
			border-radius: 10px;
			background: linear-gradient(120deg, #6366f1, #3b82f6);
			color: #fff;
			font-weight: 600;
			cursor: pointer;
			font-size: 1rem;
		}
		button:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}
		dialog {
			border: none;
			border-radius: 16px;
			padding: 24px;
			background: #0f172a;
			color: inherit;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
		}
		dialog form {
			flex-direction: column;
		}
		dialog label {
			font-size: 0.95rem;
			margin-bottom: 8px;
		}
		dialog input {
			width: 100%;
		}
		dialog button {
			margin-top: 16px;
			width: 100%;
		}
		@media (max-width: 600px) {
			body { padding: 20px 0; }
			.chat-container {
				width: 95vw;
				height: 95vh;
				border-radius: 0;
			}
			form {
				flex-direction: column;
			}
			button { width: 100%; height: 48px; }
		}
	</style>
</head>
<body>
	<main class="chat-container">
		<header>
			<h1>Projeto Redes - Chat</h1>
			<div id="status" class="status status-offline">Desconectado</div>
		</header>
		<section id="chat-log" aria-live="polite"></section>
		<form id="message-form" autocomplete="off">
			<input id="message-input" type="text" placeholder="Digite uma mensagem" maxlength="240" disabled>
			<button type="submit" disabled>Enviar</button>
		</form>
	</main>

	<dialog id="username-dialog" open>
		<form id="username-form" method="dialog" autocomplete="off">
			<label for="username-input">Escolha um nome de usuário</label>
			<input id="username-input" type="text" placeholder="Ex: Maria" maxlength="24" required>
			<button type="submit">Entrar no chat</button>
		</form>
	</dialog>

	<script>
		(() => {
			const statusEl = document.getElementById('status');
			const logEl = document.getElementById('chat-log');
			const formEl = document.getElementById('message-form');
			const inputEl = document.getElementById('message-input');
			const submitBtn = formEl.querySelector('button');
			const usernameDialog = document.getElementById('username-dialog');
			const usernameForm = document.getElementById('username-form');
			const usernameInput = document.getElementById('username-input');

			let socket = null;
			let username = '';

			const appendMessage = (text, type = 'message') => {
				const div = document.createElement('div');
				div.className = type;
				div.textContent = text;
				logEl.appendChild(div);
				logEl.scrollTop = logEl.scrollHeight;
			};

			const setStatus = (text, online) => {
				statusEl.textContent = text;
				statusEl.className = `status ${online ? 'status-online' : 'status-offline'}`;
				inputEl.disabled = !online;
				submitBtn.disabled = !online;
				if (!online) {
					inputEl.value = '';
				} else {
					inputEl.focus();
				}
			};

			const getWsUrl = () => {
				const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
				const defaultHost = '127.0.0.1:8000';
				const host = window.location.host || defaultHost;
				return `${protocol}://${host}/ws?username=${encodeURIComponent(username)}`;
			};

			const connect = () => {
				if (!username) {
					return;
				}
				socket = new WebSocket(getWsUrl());

				socket.addEventListener('open', () => {
					setStatus(`Conectado como ${username}`, true);
					appendMessage('Conexão estabelecida!', 'system');
				});

				socket.addEventListener('message', event => {
					appendMessage(event.data);
				});

				socket.addEventListener('close', () => {
					setStatus('Desconectado', false);
					appendMessage('Conexão encerrada.', 'system');
					usernameDialog.showModal();
				});

				socket.addEventListener('error', () => {
					appendMessage('Erro na conexão. Tente novamente.', 'system');
				});
			};

			usernameForm.addEventListener('submit', event => {
				event.preventDefault();
				const value = usernameInput.value.trim();
				if (!value) {
					return;
				}
				username = value;
				usernameDialog.close();
				connect();
			});

			formEl.addEventListener('submit', event => {
				event.preventDefault();
				if (!socket || socket.readyState !== WebSocket.OPEN) {
					appendMessage('Você não está conectado.', 'system');
					return;
				}
				const text = inputEl.value.trim();
				if (!text) {
					return;
				}
				socket.send(text);
				inputEl.value = '';
			});

			window.addEventListener('beforeunload', () => {
				if (socket) {
					socket.close();
				}
			});
		})();
	</script>
</body>
</html>
